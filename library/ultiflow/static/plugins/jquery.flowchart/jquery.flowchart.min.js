$((function(){$.widget("flowchart.flowchart",{options:{canUserEditLinks:!0,canUserMoveOperators:!0,data:{},distanceFromArrow:3,defaultOperatorClass:"flowchart-default-operator",defaultLinkColor:"#3366ff",defaultSelectedLinkColor:"black",linkWidth:10,grid:20,multipleLinksOnOutput:!1,multipleLinksOnInput:!1,linkVerticalDecal:0,onOperatorSelect:function(operatorId){return!0},onOperatorUnselect:function(){return!0},onLinkSelect:function(linkId){return!0},onLinkUnselect:function(){return!0},onOperatorCreate:function(operatorId,operatorData,fullElement){return!0},onLinkCreate:function(linkId,linkData){return!0},onOperatorDelete:function(operatorId){return!0},onLinkDelete:function(linkId,forced){return!0},onOperatorMoved:function(operatorId,position){},onAfterChange:function(changeType){}},data:null,objs:null,maskNum:0,linkNum:0,operatorNum:0,lastOutputConnectorClicked:null,selectedOperatorId:null,selectedLinkId:null,positionRatio:1,globalId:null,_create:function(){$app.debug&&console.log("@flowchart.flowchart: create!"),void 0===document.__flowchartNumber?document.__flowchartNumber=0:document.__flowchartNumber++,this.globalId=document.__flowchartNumber,this._unitVariables(),this.element.addClass("flowchart-container"),this.objs.layers.links=$('<svg class="flowchart-links-layer"></svg>'),this.objs.layers.links.appendTo(this.element),this.objs.layers.operators=$('<div class="flowchart-operators-layer unselectable"></div>'),this.objs.layers.operators.appendTo(this.element),this.objs.layers.temporaryLink=$('<svg class="flowchart-temporary-link-layer"></svg>'),this.objs.layers.temporaryLink.appendTo(this.element);var shape=document.createElementNS("http://www.w3.org/2000/svg","line");shape.setAttribute("x1","0"),shape.setAttribute("y1","0"),shape.setAttribute("x2","0"),shape.setAttribute("y2","0"),shape.setAttribute("stroke-dasharray","6,6"),shape.setAttribute("stroke-width","4"),shape.setAttribute("stroke","black"),shape.setAttribute("fill","none"),this.objs.layers.temporaryLink[0].appendChild(shape),this.objs.temporaryLink=shape,this._initEvents(),void 0!==this.options.data&&this.setData(this.options.data)},_unitVariables:function(){this.data={operators:{},links:{}},this.objs={layers:{operators:null,temporaryLink:null,links:null},linksContext:null,temporaryLink:null}},_initEvents:function(){var self=this;this.element.mousemove((function(e){var $this,offset=$(this).offset();self._mousemove((e.pageX-offset.left)/self.positionRatio,(e.pageY-offset.top)/self.positionRatio,e)})),this.element.click((function(e){var $this,offset=$(this).offset();self._click((e.pageX-offset.left)/self.positionRatio,(e.pageY-offset.top)/self.positionRatio,e)})),this.objs.layers.operators.on("mousedown touchstart",".flowchart-operator",(function(e){e.stopImmediatePropagation()})),this.objs.layers.operators.on("click",".flowchart-operator",(function(e){0==$(e.target).closest(".flowchart-operator-connector").length&&self.selectOperator($(this).data("operator_id"))})),this.objs.layers.operators.on("click",".flowchart-operator-connector",(function(){var $this=$(this);self.options.canUserEditLinks&&self._connectorClicked($this.closest(".flowchart-operator").data("operator_id"),$this.data("connector"),$this.data("connector_type"))})),this.objs.layers.links.on("mousedown touchstart",".flowchart-link",(function(e){e.stopImmediatePropagation()})),this.objs.layers.links.on("mouseover",".flowchart-link",(function(){self._connecterMouseOver($(this).data("link_id"))})),this.objs.layers.links.on("mouseout",".flowchart-link",(function(){self._connecterMouseOut($(this).data("link_id"))})),this.objs.layers.links.on("click",".flowchart-link",(function(){self.selectLink($(this).data("link_id"))}))},setData:function(data){for(var operatorId in this._clearOperatorsLayer(),this.data.operatorTypes={},void 0!==data.operatorTypes&&(this.data.operatorTypes=data.operatorTypes),this.data.operators={},data.operators)this.createOperator(String(operatorId),data.operators[String(operatorId)]);for(var linkId in this.data.links={},data.links)this.createLink(linkId,data.links[linkId]);this.redrawLinksLayer()},addLink:function(linkData){for(;void 0!==this.data.links[this.linkNum];)this.linkNum++;return this.createLink(this.linkNum,linkData),this.linkNum},createLink:function(linkId,linkDataOriginal){var linkData=$.extend(!0,{},linkDataOriginal);if(this.options.onLinkCreate(linkId,linkData)){var multipleLinksOnOutput=this.options.multipleLinksOnOutput,multipleLinksOnInput=this.options.multipleLinksOnInput;if(!multipleLinksOnOutput||!multipleLinksOnInput)for(var linkId2 in this.data.links){var currentLink=this.data.links[linkId2];multipleLinksOnOutput||currentLink.fromOperator!=linkData.fromOperator||currentLink.fromConnector!=linkData.fromConnector?multipleLinksOnInput||currentLink.toOperator!=linkData.toOperator||currentLink.toConnector!=linkData.toConnector||this.deleteLink(linkId2):this.deleteLink(linkId2)}this.data.links[linkId]=linkData,this._drawLink(linkId),this.options.onAfterChange("link_create")}},redrawLinksLayer:function(){for(var linkId in this._clearLinksLayer(),this.data.links)this._drawLink(linkId)},_clearLinksLayer:function(){this.objs.layers.links.empty(),this.objs.layers.operators.find(".flowchart-operator-connector-small-arrow").css("border-left-color","transparent")},_clearOperatorsLayer:function(){this.objs.layers.operators.empty()},getConnectorPosition:function(operatorId,connectorId){var operatorData=this.data.operators[String(operatorId)];if(void 0!==operatorData){var $connector=operatorData.internal.els.connectorArrows[String(connectorId)];if(void 0!==$connector){var connectorOffset=$connector.offset(),elementOffset=this.element.offset(),x,width,y;return{x:(connectorOffset.left-elementOffset.left)/this.positionRatio,width:parseInt($connector.css("border-top-width")),y:(connectorOffset.top-elementOffset.top-1)/this.positionRatio+parseInt($connector.css("border-left-width"))}}}},getLinkMainColor:function(linkId){var color=this.options.defaultLinkColor,linkData=this.data.links[linkId];return void 0!==linkData.color&&(color=linkData.color),color},setLinkMainColor:function(linkId,color){this.data.links[linkId].color=color,this.options.onAfterChange("link_change_main_color")},_drawLink:function(linkId){var linkData=this.data.links[linkId];void 0===linkData.internal&&(linkData.internal={}),linkData.internal.els={};var fromOperatorId=String(linkData.fromOperator),fromConnectorId=String(linkData.fromConnector),toOperatorId=String(linkData.toOperator),toConnectorId=String(linkData.toConnector),color=this.getLinkMainColor(linkId),fromOperator=this.data.operators[fromOperatorId],toOperator=this.data.operators[toOperatorId],fromSmallConnector={},toSmallConnector={};if(void 0!==fromOperator&&(fromSmallConnector=fromOperator.internal.els.connectorSmallArrows[fromConnectorId],linkData.internal.els.fromSmallConnector=fromSmallConnector),void 0!==toOperator&&(toSmallConnector=toOperator.internal.els.connectorSmallArrows[toConnectorId],linkData.internal.els.toSmallConnector=toSmallConnector),void 0!==fromOperator&&void 0!==toOperator){var overallGroup=document.createElementNS("http://www.w3.org/2000/svg","g");this.objs.layers.links[0].appendChild(overallGroup),linkData.internal.els.overallGroup=overallGroup;var mask=document.createElementNS("http://www.w3.org/2000/svg","mask"),maskId="fc_mask_"+this.globalId+"_"+this.maskNum;this.maskNum++,mask.setAttribute("id",maskId),overallGroup.appendChild(mask);var shape0=document.createElementNS("http://www.w3.org/2000/svg","rect");shape0.setAttribute("x","0"),shape0.setAttribute("y","0"),shape0.setAttribute("width","100%"),shape0.setAttribute("height","100%"),shape0.setAttribute("stroke","none"),shape0.setAttribute("fill","white"),mask.appendChild(shape0);var shape1=document.createElementNS("http://www.w3.org/2000/svg","polygon");shape1.setAttribute("stroke","none"),shape1.setAttribute("fill","black"),mask.appendChild(shape1),linkData.internal.els.mask=shape1;var group=document.createElementNS("http://www.w3.org/2000/svg","g");group.setAttribute("class","flowchart-link"),group.setAttribute("data-link_id",linkId),overallGroup.appendChild(group);var shape2=document.createElementNS("http://www.w3.org/2000/svg","path");shape2.setAttribute("stroke-width",this.options.linkWidth),shape2.setAttribute("fill","none"),group.appendChild(shape2),linkData.internal.els.path=shape2;var shape3=document.createElementNS("http://www.w3.org/2000/svg","rect");shape3.setAttribute("stroke","none"),shape3.setAttribute("mask","url(#"+maskId+")"),group.appendChild(shape3),linkData.internal.els.rect=shape3,this._refreshLinkPositions(linkId),this.uncolorizeLink(linkId)}},_refreshLinkPositions:function(linkId){var linkData=this.data.links[linkId],fromPosition=this.getConnectorPosition(linkData.fromOperator,linkData.fromConnector),toPosition=this.getConnectorPosition(linkData.toOperator,linkData.toConnector);if(void 0!==fromPosition&&void 0!==toPosition){var fromX=fromPosition.x,offsetFromX=fromPosition.width,fromY=fromPosition.y,toX=toPosition.x,toY=toPosition.y;fromY+=this.options.linkVerticalDecal,toY+=this.options.linkVerticalDecal;var distanceFromArrow=this.options.distanceFromArrow;linkData.internal.els.mask.setAttribute("points",fromX+","+(fromY-offsetFromX-distanceFromArrow)+" "+(fromX+offsetFromX+distanceFromArrow)+","+fromY+" "+fromX+","+(fromY+offsetFromX+distanceFromArrow));var bezierFromX=fromX+offsetFromX+distanceFromArrow,bezierToX=toX+1,bezierIntensity=Math.min(100,Math.max(Math.abs(bezierFromX-bezierToX)/2,Math.abs(fromY-toY)));linkData.internal.els.path.setAttribute("d","M"+bezierFromX+","+fromY+" C"+(fromX+offsetFromX+distanceFromArrow+bezierIntensity)+","+fromY+" "+(toX-bezierIntensity)+","+toY+" "+bezierToX+","+toY),linkData.internal.els.rect.setAttribute("x",fromX),linkData.internal.els.rect.setAttribute("y",fromY-this.options.linkWidth/2),linkData.internal.els.rect.setAttribute("width",offsetFromX+distanceFromArrow+1),linkData.internal.els.rect.setAttribute("height",this.options.linkWidth)}},getOperatorCompleteData:function(operatorData){for(var connectorId0 in void 0===operatorData.internal&&(operatorData.internal={}),this._refreshInternalProperties(operatorData),infos=$.extend(!0,{},operatorData.internal.properties),infos.inputs)null==infos.inputs[connectorId0]&&delete infos.inputs[connectorId0];for(var connectorId1 in infos.outputs)null==infos.outputs[connectorId1]&&delete infos.outputs[connectorId1];return void 0===infos.class&&(infos.class=this.options.defaultOperatorClass),infos},_getOperatorFullElement:function(operatorData){var infos=this.getOperatorCompleteData(operatorData),$operator=$('<div class="flowchart-operator"></div>');$operator.addClass(infos.class);var $operator_title=$('<div class="flowchart-operator-title"></div>');$operator_title.text(infos.title),$operator_title.appendTo($operator);var $operator_inputs_outputs=$('<div class="flowchart-operator-inputs-outputs"></div>');$operator_inputs_outputs.appendTo($operator);var $operator_inputs=$('<div class="flowchart-operator-inputs"></div>');$operator_inputs.appendTo($operator_inputs_outputs);var $operator_outputs=$('<div class="flowchart-operator-outputs"></div>');$operator_outputs.appendTo($operator_inputs_outputs);var self=this,connectorArrows={},connectorSmallArrows={};function addConnector(connectorKey,connectorInfos,$operator_container,connectorType){var $operator_connector=$('<div class="flowchart-operator-connector"></div>');$operator_connector.appendTo($operator_container),$operator_connector.data("connector",connectorKey),$operator_connector.data("connector_type",connectorType);var $operator_connector_label=$('<div class="flowchart-operator-connector-label"></div>');$operator_connector_label.text(connectorInfos.label),$operator_connector_label.appendTo($operator_connector);var $operator_connector_arrow=$('<div class="flowchart-operator-connector-arrow"></div>');$operator_connector_arrow.appendTo($operator_connector);var $operator_connector_small_arrow=$('<div class="flowchart-operator-connector-small-arrow"></div>');$operator_connector_small_arrow.appendTo($operator_connector),connectorArrows[connectorKey]=$operator_connector_arrow,connectorSmallArrows[connectorKey]=$operator_connector_small_arrow}for(var key0 in infos.inputs)addConnector(key0,infos.inputs[key0],$operator_inputs,"inputs");for(var key1 in infos.outputs)addConnector(key1,infos.outputs[key1],$operator_outputs,"outputs");return{operator:$operator,title:$operator_title,connectorArrows:connectorArrows,connectorSmallArrows:connectorSmallArrows}},getOperatorElement:function(operatorData){var fullElement;return this._getOperatorFullElement(operatorData).operator},addOperator:function(operatorData){for(;void 0!==this.data.operators[this.operatorNum];)this.operatorNum++;return this.createOperator(String(this.operatorNum),operatorData),String(this.operatorNum)},createOperator:function(operatorId,operatorData){operatorData.internal={},this._refreshInternalProperties(operatorData);var fullElement=this._getOperatorFullElement(operatorData);if(!this.options.onOperatorCreate(String(operatorId),operatorData,fullElement))return!1;var grid=this.options.grid;operatorData.top=Math.round(operatorData.top/grid)*grid,operatorData.left=Math.round(operatorData.left/grid)*grid,fullElement.operator.appendTo(this.objs.layers.operators),fullElement.operator.css({top:operatorData.top,left:operatorData.left}),fullElement.operator.data("operator_id",String(operatorId)),this.data.operators[String(operatorId)]=operatorData,this.data.operators[String(operatorId)].internal.els=fullElement,operatorId==this.selectedOperatorId&&this._addSelectedClass(String(operatorId));var operatorData1=this.data.operators[String(operatorId)],self=this,pointerX,pointerY;function operatorChangedPosition(operator_id,pos){for(var linkId in operatorData1.top=pos.top,operatorData1.left=pos.left,self.data.links){var linkData=self.data.links[linkId];linkData.fromOperator!=operator_id&&linkData.toOperator!=operator_id||self._refreshLinkPositions(linkId)}}this.options.canUserMoveOperators&&fullElement.operator.draggable({handle:".flowchart-operator-title",start:function(e,ui){if(null==self.lastOutputConnectorClicked){var elementOffset=self.element.offset();pointerX=(e.pageX-elementOffset.left)/self.positionRatio-parseInt($(e.target).css("left")),pointerY=(e.pageY-elementOffset.top)/self.positionRatio-parseInt($(e.target).css("top"))}else e.preventDefault()},drag:function(e,ui){var grid=self.options.grid,elementOffset=self.element.offset();ui.position.left=Math.round(((e.pageX-elementOffset.left)/self.positionRatio-pointerX)/grid)*grid,ui.position.top=Math.round(((e.pageY-elementOffset.top)/self.positionRatio-pointerY)/grid)*grid,ui.offset.left=Math.round(ui.position.left+elementOffset.left),ui.offset.top=Math.round(ui.position.top+elementOffset.top),fullElement.operator.css({left:ui.position.left,top:ui.position.top}),operatorChangedPosition($(this).data("operator_id"),ui.position)},stop:function(e,ui){self._unsetTemporaryLink();var operatorId=$(this).data("operator_id");operatorChangedPosition(String(operatorId),ui.position),self.options.onOperatorMoved(String(operatorId),ui.position),self.options.onAfterChange("operator_moved")}});this.options.onAfterChange("operator_create")},_connectorClicked:function(operator,connector,connectorCategory){if("outputs"==connectorCategory){var d,currentTime=(new Date).getTime();this.lastOutputConnectorClicked={operator:String(operator),connector:String(connector)},this.objs.layers.temporaryLink.show();var position=this.getConnectorPosition(operator,connector),x=position.x+position.width,y=position.y;this.objs.temporaryLink.setAttribute("x1",x),this.objs.temporaryLink.setAttribute("y1",y),this._mousemove(x,y)}if("inputs"==connectorCategory&&null!=this.lastOutputConnectorClicked){var linkData={fromOperator:this.lastOutputConnectorClicked.operator,fromConnector:this.lastOutputConnectorClicked.connector,toOperator:operator,toConnector:connector};this.addLink(linkData),this._unsetTemporaryLink()}},_unsetTemporaryLink:function(){this.lastOutputConnectorClicked=null,this.objs.layers.temporaryLink.hide()},_mousemove:function(x,y,e){null!=this.lastOutputConnectorClicked&&(this.objs.temporaryLink.setAttribute("x2",x),this.objs.temporaryLink.setAttribute("y2",y))},_click:function(x,y,e){var $target=$(e.target);0==$target.closest(".flowchart-operator-connector").length&&this._unsetTemporaryLink(),0==$target.closest(".flowchart-operator").length&&this.unselectOperator(),0==$target.closest(".flowchart-link").length&&this.unselectLink()},_removeSelectedClassOperators:function(){this.objs.layers.operators.find(".flowchart-operator").removeClass("selected")},unselectOperator:function(){if(null!=this.selectedOperatorId){if(!this.options.onOperatorUnselect())return;this._removeSelectedClassOperators(),this.selectedOperatorId=null}},_addSelectedClass:function(operatorId){this.data.operators[String(operatorId)].internal.els.operator.addClass("selected")},selectOperator:function(operatorId){this.options.onOperatorSelect(String(operatorId))&&(this.unselectLink(),this._removeSelectedClassOperators(),this._addSelectedClass(String(operatorId)),this.selectedOperatorId=String(operatorId))},getSelectedOperatorId:function(){return String(this.selectedOperatorId)},getSelectedLinkId:function(){return this.selectedLinkId},_shadeColor:function(color,percent){var f=parseInt(color.slice(1),16),t=percent<0?0:255,p=percent<0?-1*percent:percent,R=f>>16,G=f>>8&255,B=255&f;return"#"+(16777216+65536*(Math.round((t-R)*p)+R)+256*(Math.round((t-G)*p)+G)+(Math.round((t-B)*p)+B)).toString(16).slice(1)},colorizeLink:function(linkId,color){var linkData=this.data.links[linkId];void 0!==linkData.internal.els.path&&void 0!==linkData.internal.els.fromSmallConnector&&void 0!==linkData.internal.els.toSmallConnector&&(linkData.internal.els.path.setAttribute("stroke",color),linkData.internal.els.rect.setAttribute("fill",color),linkData.internal.els.fromSmallConnector.css("border-left-color",color),linkData.internal.els.toSmallConnector.css("border-left-color",color))},uncolorizeLink:function(linkId){this.colorizeLink(linkId,this.getLinkMainColor(linkId))},_connecterMouseOver:function(linkId){this.selectedLinkId!=linkId&&this.colorizeLink(linkId,this._shadeColor(this.getLinkMainColor(linkId),-.4))},_connecterMouseOut:function(linkId){this.selectedLinkId!=linkId&&this.uncolorizeLink(linkId)},unselectLink:function(){if(null!=this.selectedLinkId){if(!this.options.onLinkUnselect())return;this.uncolorizeLink(this.selectedLinkId,this.options.defaultSelectedLinkColor),this.selectedLinkId=null}},selectLink:function(linkId){this.unselectLink(),this.options.onLinkSelect(linkId)&&(this.unselectOperator(),this.selectedLinkId=linkId,this.colorizeLink(linkId,this.options.defaultSelectedLinkColor))},deleteOperator:function(operatorId){this._deleteOperator(String(operatorId),!1)},_deleteOperator:function(operatorId,replace){if(!this.options.onOperatorDelete(String(operatorId),replace))return!1;if(!replace)for(var linkId in this.data.links){var currentLink=this.data.links[linkId];currentLink.fromOperator!=operatorId&&currentLink.toOperator!=operatorId||this._deleteLink(linkId,!0)}replace||operatorId!=this.selectedOperatorId||this.unselectOperator(),this.data.operators[String(operatorId)].internal.els.operator.remove(),delete this.data.operators[String(operatorId)],this.options.onAfterChange("operator_delete")},destroyLinks:function(){for(let linkId in this.data.links)this.selectedLinkId==linkId&&this.unselectLink(),delete this.data.links[linkId]},deleteLink:function(linkId){this._deleteLink(linkId,!1)},_deleteLink:function(linkId,forced){this.selectedLinkId==linkId&&this.unselectLink(),(this.options.onLinkDelete(linkId,forced)||forced)&&(this.colorizeLink(linkId,"transparent"),void 0!==this.data.links[linkId].internal.els.overallGroup&&this.data.links[linkId].internal.els.overallGroup.remove(),delete this.data.links[linkId],this.options.onAfterChange("link_delete"))},deleteSelected:function(){null!=this.selectedLinkId&&this.deleteLink(this.selectedLinkId),null!=this.selectedOperatorId&&this.deleteOperator(String(this.selectedOperatorId))},setPositionRatio:function(positionRatio){this.positionRatio=positionRatio},getPositionRatio:function(){return this.positionRatio},getData:function(){var keys=["operators","links"],data={};for(var keyI in data.operators=$.extend(!0,{},this.data.operators),data.links=$.extend(!0,{},this.data.links),keys){var key=keys[keyI];for(var objId in data[key])delete data[key][objId].internal}return data.operatorTypes=this.data.operatorTypes,data},getFullData:function(){var keys=["operators","links"],data={};return data.operators=$.extend(!0,{},this.data.operators),data.links=$.extend(!0,{},this.data.links),data.operatorTypes=this.data.operatorTypes,data},setOperatorTitle:function(operatorId,title){this.data.operators[String(operatorId)].internal.els.title.text(title),void 0===this.data.operators[String(operatorId)].properties&&(this.data.operators[String(operatorId)].properties={}),this.data.operators[String(operatorId)].properties.title=title,this._refreshInternalProperties(this.data.operators[String(operatorId)]),this.options.onAfterChange("operator_title_change")},getOperatorTitle:function(operatorId){return this.data.operators[String(operatorId)].internal.properties.title},setOperatorData:function(operatorId,operatorData){var infos=this.getOperatorCompleteData(operatorData);for(var linkId in this.data.links){var linkData=this.data.links[linkId];(linkData.fromOperator==operatorId&&void 0===infos.outputs[String(linkData.fromConnector)]||linkData.toOperator==operatorId&&void 0===infos.inputs[String(linkData.toConnector)])&&this._deleteLink(linkId,!0)}this._deleteOperator(operatorId,!0),this.createOperator(operatorId,operatorData),this.redrawLinksLayer(),this.options.onAfterChange("operator_data_change")},getOperatorData:function(operatorId){var data=$.extend(!0,{},this.data.operators[String(operatorId)]);return delete data.internal,data},getOperatorFullProperties:function(operatorData){if(void 0!==operatorData.type){var typeProperties=this.data.operatorTypes[operatorData.type],operatorProperties={};return void 0!==operatorData.properties&&(operatorProperties=operatorData.properties),$.extend({},typeProperties,operatorProperties)}return operatorData.properties},_refreshInternalProperties:function(operatorData){operatorData.internal.properties=this.getOperatorFullProperties(operatorData)}})}));